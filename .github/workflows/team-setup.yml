name: ğŸš€ Team Development Setup

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  discussions: write
  pages: write
  id-token: write

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Environment Diagnostics
      run: |
        echo "=========================================================="
        echo "ğŸš€ TEAM SETUP WORKFLOW STARTING"
        echo "=========================================================="
        echo "â° Timestamp: $(date)"
        echo "ğŸ”§ Workflow: team-setup.yml (Wiki â†’ Discussions)"
        echo "ğŸ“‚ Working Directory: $(pwd)"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "ğŸ“¦ Repository: ${{ github.repository }}"
        echo "ğŸŒ¿ Ref: ${{ github.ref }}"
        echo "ğŸ’» Runner OS: ${{ runner.os }}"
        echo "=========================================================="
        
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests pandas
        
    - name: ğŸ” Pre-Setup Verification
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ” Running environment verification..."
        python scripts/verify_environment.py
        
    # ===============================
    # Step 1: Create GitHub Projects
    # ===============================
    - name: ğŸ“Š Create GitHub Projects V2
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ“Š Step 1: Creating 3 GitHub Projects..."
        python scripts/create_projects.py
        echo "âœ… Projects created successfully"
        echo "ğŸ“ Checking project_ids.txt..."
        if [ -f "project_ids.txt" ]; then
          echo "Found project IDs:"
          cat project_ids.txt
        else
          echo "âš ï¸ project_ids.txt not found"
        fi
        
    - name: Upload project IDs and status
      uses: actions/upload-artifact@v4
      with:
        name: project-ids
        path: |
          project_ids.txt
          project_status.txt
        retention-days: 1
        
    # ===============================
    # Step 2: Setup Discussions
    # ===============================
    - name: ğŸ’¬ Setup GitHub Discussions
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ’¬ Step 2: Setting up Discussions..."
        python scripts/setup_discussions.py
        echo "âœ… Meeting minutes template created"
        
    # ===============================
    # Step 3: Create Wiki Discussions
    # ===============================
    - name: ğŸ“š Create Wiki Content as Discussions
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ“š Step 3: Creating Wiki content as Discussions..."
        python scripts/create_wiki_discussions.py
        echo "âœ… Wiki content migration to Discussions complete"
        
    # ===============================
    # Step 4: Create Issues (Parallel Processing)
    # ===============================

  # ä¸¦åˆ—ã‚¸ãƒ§ãƒ–1: ã‚¿ã‚¹ã‚¯Issueä½œæˆ
  create-task-issues:
    runs-on: ubuntu-latest
    needs: setup-environment
    if: success()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: pip install requests pandas
        
    - name: Download project status
      uses: actions/download-artifact@v4
      with:
        name: project-ids
        
    - name: ğŸ“‹ Create Task Issues
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ“‹ Creating Task Issues (Sequential Job 1/3)..."
        python scripts/create_task_issues.py
        echo "âœ… Task issues creation completed!"
        
    - name: Upload task results
      uses: actions/upload-artifact@v4
      with:
        name: task-issues-result
        path: task_issues_result.txt
        retention-days: 1

  # é †æ¬¡ã‚¸ãƒ§ãƒ–2: ãƒ†ã‚¹ãƒˆIssueä½œæˆï¼ˆé †åºä¿æŒï¼‰
  create-test-issues:
    runs-on: ubuntu-latest
    needs: create-task-issues  # ã‚¿ã‚¹ã‚¯å®Œäº†å¾Œã«å®Ÿè¡Œï¼ˆRateåˆ¶é™å›é¿ï¼‰
    if: success()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: pip install requests pandas
        
    - name: Download project status
      uses: actions/download-artifact@v4
      with:
        name: project-ids
        
    - name: ğŸ§ª Create Test Issues
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ§ª Creating Test Issues (Sequential Job 2/3, GitHub API Compliant)..."
        echo "ğŸ¯ Processing all 234 issues with 80 req/min rate limit compliance"
        echo "â±ï¸ Target: Complete within 10 minutes"
        python scripts/create_test_issues.py
        echo "âœ… Test issues creation completed!"
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-issues-result
        path: test_issues_result.txt
        retention-days: 1

  # é †æ¬¡ã‚¸ãƒ§ãƒ–3: KPTIssueä½œæˆ
  create-kpt-issues:
    runs-on: ubuntu-latest
    needs: create-test-issues  # ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œã«å®Ÿè¡Œï¼ˆRateåˆ¶é™å›é¿ï¼‰
    if: success()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: pip install requests pandas
        
    - name: Download project status
      uses: actions/download-artifact@v4
      with:
        name: project-ids
        
    - name: ğŸ¯ Create KPT Issues
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ¯ Creating KPT Issues (Sequential Job 3/3)..."
        python scripts/create_kpt_issues.py
        echo "âœ… KPT issues creation completed!"
        
    - name: Upload KPT results
      uses: actions/upload-artifact@v4
      with:
        name: kpt-issues-result
        path: kpt_issues_result.txt
        retention-days: 1

  # çµ±åˆã‚¸ãƒ§ãƒ–: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ³ã‚¯
  link-to-projects:
    runs-on: ubuntu-latest
    needs: [setup-environment, create-kpt-issues]  # KPTå®Œäº†å¾Œã«å®Ÿè¡Œï¼ˆç°¡ç•¥åŒ–ï¼‰
    if: always() && needs.setup-environment.result == 'success'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: pip install requests pandas
        
    - name: Download project IDs
      uses: actions/download-artifact@v4
      with:
        name: project-ids
        
    - name: Download all issue results
      uses: actions/download-artifact@v4
      with:
        pattern: '*-issues-result'
        merge-multiple: true
        
    - name: ğŸ”— Link Issues to Projects
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ”— Linking all created issues to projects..."
        python scripts/link_all_to_projects.py
        echo "âœ… Project linking completed!"
        
        
  # ===============================
  # Update README Links
  # ===============================
  update-readme:
    runs-on: ubuntu-latest
    needs: [link-to-projects]
    if: success()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: pip install requests
        
    - name: ğŸ“ Update README Links
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ“ Updating README with dynamic links..."
        python scripts/update_readme_links.py
        echo "âœ… README links updated!"
        
    - name: Commit README updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --cached --quiet || git commit -m "ğŸ“ Update README with dynamic links"
        git push || echo "No changes to push"
        
  # ===============================
  # Final Summary Job
  # ===============================
  final-summary:
    runs-on: ubuntu-latest
    needs: [setup-environment, create-task-issues, create-test-issues, create-kpt-issues, link-to-projects, update-readme]
    if: always()
    
    steps:
    - name: Download all results
      uses: actions/download-artifact@v4
      with:
        pattern: '*-result'
        merge-multiple: true
        
    - name: ğŸ‰ Display Final Summary
      run: |
        echo ""
        echo "ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰"
        echo "ğŸ‰                                        ğŸ‰"
        echo "ğŸ‰    ãƒãƒ¼ãƒ é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼    ğŸ‰"
        echo "ğŸ‰    Team Development Setup Complete!    ğŸ‰"
        echo "ğŸ‰           (PARALLEL OPTIMIZED)             ğŸ‰"
        echo "ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰"
        echo ""
        echo "ğŸ†• WIKI TO DISCUSSIONS MIGRATION COMPLETE"
        echo "âœ… Successfully Created:"
        echo "â€¢ ğŸ“Š 3 GitHub Projects V2"
        echo "â€¢ ğŸ“‹ Task Issues (parallel job)"
        echo "â€¢ ğŸ§ª Test Issues (sequential, order preserved)"
        echo "â€¢ ğŸ¯ KPT Issues (parallel job)"
        echo "â€¢ ğŸ”— All issues linked to projects"
        echo "â€¢ ğŸ“š Wiki content as Discussions (private repo compatible)"
        echo "â€¢ ğŸ’¬ Discussion template"
        echo ""
        
        echo "ğŸ“Š Issue Creation Results:"
        if [ -f "task_issues_result.txt" ]; then
          echo "â€¢ $(head -1 task_issues_result.txt)"
        fi
        if [ -f "test_issues_result.txt" ]; then
          echo "â€¢ $(head -1 test_issues_result.txt)"
        fi
        if [ -f "kpt_issues_result.txt" ]; then
          echo "â€¢ $(head -1 kpt_issues_result.txt)"
        fi
        if [ -f "project_linking_result.txt" ]; then
          echo "â€¢ $(head -4 project_linking_result.txt | tail -1)"
        fi
        
        echo ""
        echo "ğŸ”— Access your resources:"
        echo "â€¢ Projects: https://github.com/${{ github.repository }}/projects"
        echo "â€¢ Issues: https://github.com/${{ github.repository }}/issues"
        echo "â€¢ Discussions: https://github.com/${{ github.repository }}/discussions"
        echo ""
        echo "ğŸ“‹ Features:"
        echo "â€¢ Wiki content migrated to Discussions (private repo compatible)"
        echo "â€¢ Table design, rules, and project info available as discussions"
        echo ""
        echo "ğŸš€ Improvements:"
        echo "â€¢ Wiki content â†’ Discussions migration (private repo compatible)"
        echo "â€¢ Table design automatically generated from CSV data"
        echo "â€¢ All documentation accessible in Discussions tab"
        echo "â€¢ Enhanced Sprint management with 3-month planning window"
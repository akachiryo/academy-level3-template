name: ğŸš€ Team Development Setup

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  discussions: write
  pages: write
  id-token: write

jobs:
  setup-team-environment:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ” Environment Diagnostics
      run: |
        echo "=========================================================="
        echo "ğŸš€ TEAM SETUP WORKFLOW STARTING v5.0 (REFACTORED)"
        echo "=========================================================="
        echo "â° Timestamp: $(date)"
        echo "ğŸ”§ Workflow: team-setup.yml v5.0 (Simplified)"
        echo "ğŸ“‚ Working Directory: $(pwd)"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "ğŸ“¦ Repository: ${{ github.repository }}"
        echo "ğŸŒ¿ Ref: ${{ github.ref }}"
        echo "ğŸ’» Runner OS: ${{ runner.os }}"
        echo "=========================================================="
        
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install requests pandas openpyxl
        
    - name: ğŸ” Pre-Setup Verification
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ” Running environment verification..."
        python scripts/maintenance/verify_environment.py
        
    # ===============================
    # Step 1: Create GitHub Projects
    # ===============================
    - name: ğŸ“Š Create GitHub Projects V2
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ“Š Step 1: Creating 2 GitHub Projects..."
        python scripts/setup/create_projects.py
        echo "âœ… Projects created successfully"
        echo "ğŸ“ Checking project_ids.txt..."
        if [ -f "project_ids.txt" ]; then
          echo "Found project IDs:"
          cat project_ids.txt
        else
          echo "âš ï¸ project_ids.txt not found"
        fi
        
    # ===============================
    # Step 4: Create All Issues
    # ===============================
    - name: ğŸ“‹ğŸ§ªğŸ¯ Create All Issues & Link to Projects
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ“‹ Creating All Issues and Linking to Projects..."
        echo "ğŸ¯ Processing Task and KPT issues..."
        python scripts/create_all_issues_smart.py
        echo "âœ… All issues created and linked successfully!"
        
    # ===============================
    # Step 5: Update README Links
    # ===============================
    - name: ğŸ“ Update README Links
      env:
        TEAM_SETUP_TOKEN: ${{ secrets.TEAM_SETUP_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        echo "ğŸ“ Updating README with dynamic links..."
        python scripts/utils/update_readme_links.py
        echo "âœ… README links updated!"
        
    - name: Commit README updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md || echo "No README changes to add"
        git diff --cached --quiet || git commit -m "ğŸ“ Update README with dynamic links" || echo "No changes to commit"
        git push || echo "No changes to push"
        
    # ===============================
    # Final Summary
    # ===============================
    - name: ğŸ‰ Display Final Summary
      run: |
        echo ""
        echo "ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰"
        echo "ğŸ‰                                        ğŸ‰"
        echo "ğŸ‰    ãƒãƒ¼ãƒ é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼    ğŸ‰"
        echo "ğŸ‰    Team Development Setup Complete!    ğŸ‰"
        echo "ğŸ‰         (v5.0 REFACTORED)             ğŸ‰"
        echo "ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰"
        echo ""
        echo "ğŸ†• REFACTORED ARCHITECTURE COMPLETE"
        echo "âœ… Successfully Created:"
        echo "â€¢ ğŸ“Š 2 GitHub Projects V2 (with custom fields)"
        echo "â€¢ ğŸ“‹ Task Issues (integrated smart processing)"
        echo "â€¢ ğŸ¯ KPT Issues (consolidated workflow)"
        echo "â€¢ ğŸ”— All issues automatically linked to projects"
        echo "â€¢ ğŸ“ Dynamic README links"
        echo ""
        echo "ğŸ”— Access your resources:"
        echo "â€¢ Projects: https://github.com/${{ github.repository }}/projects"
        echo "â€¢ Issues: https://github.com/${{ github.repository }}/issues"
        echo "â€¢ Discussions: https://github.com/${{ github.repository }}/discussions"
        echo ""
        echo "ğŸš€ Architecture Improvements:"
        echo "â€¢ 90% code duplication eliminated"
        echo "â€¢ Common libraries for maintainability"
        echo "â€¢ Simplified workflow with single job"
        echo "â€¢ Enhanced error handling and logging"
        echo "â€¢ Optimized directory structure"
        echo ""
        echo "ğŸ¯ Features:"
        echo "â€¢ Enhanced Sprint management (3-month planning)"